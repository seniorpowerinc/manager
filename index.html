<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎁 GitHub 禮物網站管理</title>
  <style>
    /* ===== 全局 Reset & 變量 ===== */
    * { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --gradient-primary: linear-gradient(135deg,#667eea,#764ba2);
      --gradient-button: linear-gradient(135deg,#4facfe,#00f2fe);
      --radius: 12px;
      --shadow: 0 10px 25px rgba(0,0,0,.1);
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--gradient-primary);
      min-height:100vh; padding:20px; color:#333;
    }
    .container {
      max-width:1200px; margin:0 auto;
      background:rgba(255,255,255,0.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    h1,h2,h3 { font-weight:300; }
    /* ===== Header ===== */
    .header {
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:#fff; text-align:center; padding:30px 20px;
    }
    .header h1 { font-size:2.5rem; }
    .header p  { opacity:.9; margin-top:8px; }

    /* ===== Buttons ===== */
    .btn {
      display:inline-block;
      background: var(--gradient-button);
      color:#fff; border:none; border-radius:25px;
      padding:12px 24px; font-size:1rem; font-weight:600;
      cursor:pointer; transition:transform .2s, box-shadow .2s;
      text-align:center;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,.15);
    }
    .btn:disabled {
      background:#ccc; cursor:not-allowed; transform:none; box-shadow:none;
    }
    .btn.success { background: linear-gradient(135deg,#56ab2f,#a8e6cf); }
    .btn.warning { background: linear-gradient(135deg,#f093fb,#f5576c); }
    .btn.danger  { background: linear-gradient(135deg,#ff6b6b,#ee5a52); }

    /* ===== Sections ===== */
    .section {
      padding:30px; margin:20px;
      border-radius: var(--radius);
      background: linear-gradient(135deg,#ffecd2,#fcb69f);
    }
    .section.authenticated { background: linear-gradient(135deg,#a8edea,#fed6e3); }
    .info-box {
      background: #e3f2fd; border-left:4px solid #2196f3;
      border-radius: var(--radius); padding:20px; margin-bottom:20px;
    }
    .permissions-list { padding-left:20px; margin-top:10px; }
    .permissions-list li { margin-bottom:6px; }

    .form-group { margin-bottom:16px; }
    .form-group label { display:block; margin-bottom:6px; font-weight:600; }
    .form-group input,
    .form-group textarea {
      width:100%; padding:10px; border:2px solid #ddd;
      border-radius:8px; font-size:1rem;
      transition:border-color .2s;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline:none; border-color:#4facfe;
    }

    /* ===== Repo 卡片 ===== */
    .repos-grid {
      display:grid; gap:20px;
      grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
      margin-top:20px;
    }
    .repo-card {
      background:#fff; border-radius:var(--radius);
      box-shadow: var(--shadow); padding:20px;
      transition:transform .2s, box-shadow .2s;
      border:2px solid transparent;
    }
    .repo-card:hover {
      transform:translateY(-4px);
      box-shadow:0 16px 32px rgba(0,0,0,.15);
      border-color:#4facfe;
    }
    .repo-header {
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:12px;
    }
    .repo-name { font-size:1.2rem; font-weight:600; }
    .status-indicator {
      padding:4px 10px; border-radius:20px; font-size:.85rem; font-weight:600;
    }
    .status-active   { background:#d4edda; color:#155724; }
    .status-inactive { background:#f8d7da; color:#721c24; }
    .repo-url { margin-bottom:8px; font-size:.9rem; word-break:break-all; }
    .repo-url a { color:#4facfe; text-decoration:none; }
    .repo-actions { display:flex; flex-wrap:wrap; gap:8px; }

    /* ===== Loading Spinner ===== */
    .loading {
      width:18px; height:18px; border:3px solid #f3f3f3;
      border-top:3px solid #4facfe; border-radius:50%;
      animation:spin 1s linear infinite; display:inline-block; vertical-align:middle;
      margin-left:8px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* ===== Modal ===== */
    .modal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.6); justify-content:center; align-items:center;
      z-index:1000;
    }
    .modal.show { display:flex; }
    .modal-content {
      background:#fff; padding:24px; border-radius:var(--radius);
      max-width:400px; width:90%; position:relative;
    }
    .modal-content .close {
      position:absolute; top:12px; right:12px; cursor:pointer;
      font-size:1.4rem; color:#666;
    }
    .modal-content .close:hover { color:#000; }

    /* ===== Responsive ===== */
    @media(max-width:600px) {
      .repos-grid { grid-template-columns:1fr; }
      .header h1 { font-size:2rem; }
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>🎁 GitHub 禮物網站管理</h1>
      <p>統一上傳、配置、啟用 GitHub Pages</p>
    </div>

    <div class="main-content">
      <!-- 認證 -->
      <div id="authSection" class="section">
        <h2>🔐 GitHub 認證</h2>
        <div class="info-box">
          <p>請至 GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)，建立 Token，並授予：</p>
          <ul class="permissions-list">
            <li>repo</li>
            <li>delete_repo</li>
            <li>user</li>
          </ul>
        </div>
        <div class="form-group">
          <label>Personal Access Token</label>
          <input id="tokenInput" type="password" placeholder="輸入 PAT (Classic)">
        </div>
        <button id="loginBtn" class="btn">登入</button>
        <div id="userInfo" class="info-box hidden" style="margin-top:20px; display:flex; justify-content:space-between;">
          <span>已登入：<strong id="username"></strong></span>
          <button class="btn danger" onclick="logout()">登出</button>
        </div>
      </div>

      <!-- 新增 Repo -->
      <div id="addRepoSection" class="section hidden">
        <h2>➕ 新增禮物網站</h2>
        <div class="form-group">
          <label>Repo 名稱</label>
          <input id="repoName" type="text" placeholder="例如：my-gift-site">
        </div>
        <div class="form-group">
          <label>描述（可選）</label>
          <textarea id="repoDescription" rows="2" placeholder="這個禮物網站的描述…"></textarea>
        </div>
        <div class="form-group">
          <label>上傳封面圖片</label>
          <input id="coverImageFile" type="file" accept="image/*">
        </div>
        <div class="form-group">
          <label>PDF 網址</label>
          <input id="pdfUrl" type="text" placeholder="https://drive.google.com/...">
        </div>
        <button id="createRepoBtn" class="btn success">創建</button>
      </div>

      <!-- Repo 列表 -->
      <div id="reposList" class="section hidden">
        <h2>📦 我的禮物網站</h2>
        <div id="reposGrid" class="repos-grid"></div>
      </div>
    </div>
  </div>

  <!-- 重新命名 Modal -->
  <div id="renameModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeRenameModal()">&times;</span>
      <h3>重新命名 Repo</h3>
      <div class="form-group">
        <label>新名稱</label>
        <input id="newRepoName" type="text">
      </div>
      <div class="form-group">
        <label>新描述</label>
        <textarea id="newRepoDescription" rows="2"></textarea>
      </div>
      <button class="btn success" onclick="confirmRename()">確認</button>
      <button class="btn" onclick="closeRenameModal()">取消</button>
    </div>
  </div>


<script>
// —— 全域變數 —— 
let currentToken='', currentUser='', renameTarget='';

// —— 認證 —— 
document.getElementById('loginBtn').onclick = authenticate;
async function authenticate(){
  const token = document.getElementById('tokenInput').value.trim();
  if(!token){ alert('請輸入 Token'); return; }
  const btn = document.getElementById('loginBtn');
  btn.innerHTML = '驗證中…<span class="loading"></span>'; btn.disabled=true;
  try {
    const res = await fetch('https://api.github.com/user',{
      headers:{ 'Authorization':`token ${token}` }
    });
    if(!res.ok) throw new Error('Token 無效或權限不足');
    const user = await res.json();
    currentToken = token; currentUser = user.login;
    // 切換 UI
    document.getElementById('authSection').classList.add('authenticated');
    document.getElementById('username').textContent = user.login;
    document.getElementById('userInfo').style.display = 'flex';
    document.getElementById('tokenInput').style.display = 'none';
    btn.style.display = 'none';
    document.getElementById('addRepoSection').classList.remove('hidden');
    document.getElementById('reposList').classList.remove('hidden');
    await loadRepos();
  } catch(e){
    alert('認證失敗：'+e.message);
  } finally {
    btn.innerHTML='登入'; btn.disabled=false;
  }
}

// —— 登出 —— 
function logout(){ location.reload(); }

// —— 載入 & 篩選 Repos —— 
async function loadRepos(){
  const grid = document.getElementById('reposGrid');
  grid.innerHTML = '';
  try {
    let res = await fetch('https://api.github.com/user/repos?per_page=100&sort=updated',{
      headers:{ 'Authorization':`token ${currentToken}` }
    });
    if(!res.ok) throw new Error('無法取得 Repos');
    const list = await res.json(), filtered=[];
    for(const r of list){
      let check = await fetch(`https://api.github.com/repos/${r.full_name}/contents/data.json`,{
        headers:{ 'Authorization':`token ${currentToken}` }
      });
      if(check.ok) filtered.push(r);
    }
    if(filtered.length===0){
      grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#666;">尚無任何禮物網站</p>';
      return;
    }
    displayRepos(filtered);
  } catch(e){
    alert('載入失敗：'+e.message);
  }
}

// —— 顯示 Cards —— 
function displayRepos(repos){
  const grid = document.getElementById('reposGrid');
  repos.forEach(r=>{
    const url = `https://${r.owner.login}.github.io/${r.name}/`;
    const card = document.createElement('div'); card.className='repo-card';
    card.innerHTML = `
      <div class="repo-header">
        <div class="repo-name">${r.name}</div>
        <div class="status-indicator ${r.has_pages?'status-active':'status-inactive'}">
          ${r.has_pages?'已發布':'未發布'}
        </div>
      </div>
      <div class="repo-url"><a href="${url}" target="_blank">${url}</a></div>
      <div class="repo-url">描述：${r.description||'—'}</div>
      <div class="repo-url">更新：${new Date(r.updated_at).toLocaleString('zh-TW')}</div>
      <div class="repo-actions">
        <button class="btn" onclick="openSite('${url}')">訪問</button>
        <button class="btn warning" onclick="openRenameModal('${r.name}','${r.description||''}')">重新命名</button>
        <button class="btn" onclick="enablePages('${r.name}')" ${r.has_pages?'style="display:none"':''}>啟用 Pages</button>
        <button class="btn danger" onclick="deleteRepo('${r.name}')">刪除</button>
      </div>`;
    grid.appendChild(card);
  });
}

// —— 新增 Repo —— 
document.getElementById('createRepoBtn').onclick = createRepo;
async function createRepo(){
  const name = document.getElementById('repoName').value.trim();
  if(!name){ alert('請輸入名稱'); return; }
  const desc = document.getElementById('repoDescription').value.trim();
  const pdf  = document.getElementById('pdfUrl').value.trim();
  const fileInput = document.getElementById('coverImageFile');
  if(!pdf){ alert('請輸入 PDF 網址'); return; }
  if(!fileInput.files.length){ alert('請上傳封面圖片'); return; }

  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = async () => {
    const base64 = reader.result.split(',')[1];
    const imgName = file.name;

    const btn = document.getElementById('createRepoBtn');
    btn.innerHTML = '創建中…<span class="loading"></span>'; btn.disabled=true;

    try {
      // 1. 建 repo
      let res = await fetch('https://api.github.com/user/repos',{
        method:'POST',
        headers:{
          'Authorization':`token ${currentToken}`,
          'Content-Type':'application/json'
        },
        body: JSON.stringify({
          name, description: desc||`${name} 禮物網站`, private:false, auto_init:true
        })
      });
      if(!res.ok) throw new Error((await res.json()).message||'創建失敗');
      await new Promise(r=>setTimeout(r,2000));

      // 2. 建 images/.gitkeep
      await uploadFile(name,'images/.gitkeep','CiMgIGlmIHRoaXMgaXMgYSBnb29kIGZvbGRlcg==');

      // 3. 上傳封面圖片
      await uploadFile(name,`images/${imgName}`, base64);

      // 4. 上傳 index.html（使用你提供的模板）
      const indexHtml = await (await fetch('index.html')).text(); 
      await uploadFile(name,'index.html', btoa(unescape(encodeURIComponent(indexHtml))));

      // 5. 上傳 data.json
      const dataJson = {
        pageTitle: `${name} - 禮物`,
        lang: 'zh-TW',
        pdf: pdf,
        coverImage: `images/${imgName}`
      };
      await uploadFile(name,'data.json', btoa(unescape(encodeURIComponent(JSON.stringify(dataJson,null,2)))));

      // 6. .github/workflows/deploy.yml
      const deployYml = `name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: \${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/configure-pages@v3
      - uses: actions/upload-pages-artifact@v2
        with:
          path: '.'
      - id: deployment
        uses: actions/deploy-pages@v2`;
      await uploadFile(name,'.github/workflows/deploy.yml', btoa(unescape(encodeURIComponent(deployYml))));

      // 7. 啟用 Pages
      await enablePages(name);

      alert('禮物網站已建立！');
      document.getElementById('repoName').value='';
      document.getElementById('repoDescription').value='';
      document.getElementById('pdfUrl').value='';
      fileInput.value = '';
      await loadRepos();

    } catch(e){
      alert('錯誤：'+e.message);
    } finally {
      btn.innerHTML='創建'; btn.disabled=false;
    }
  };
  reader.readAsDataURL(file);
}

// —— 上傳檔案 —— 
async function uploadFile(repo,path,contentB64){
  const res = await fetch(`https://api.github.com/repos/${currentUser}/${repo}/contents/${path}`, {
    method:'PUT',
    headers:{
      'Authorization':`token ${currentToken}`,
      'Content-Type':'application/json'
    },
    body: JSON.stringify({
      message: `Add ${path}`,
      content: contentB64
    })
  });
  if(!res.ok) throw new Error(`上傳 ${path} 失敗`);
}

// —— 其餘功能同前：重新命名、刪除、啟用 Pages、開新分頁 —— 
function openRenameModal(n,d){ renameTarget=n; document.getElementById('newRepoName').value=n; document.getElementById('newRepoDescription').value=d; document.getElementById('renameModal').classList.add('show'); }
function closeRenameModal(){ document.getElementById('renameModal').classList.remove('show'); }
async function confirmRename(){
  const newName = document.getElementById('newRepoName').value.trim();
  if(!newName){ alert('名稱不可空'); return; }
  const newDesc = document.getElementById('newRepoDescription').value.trim();
  try {
    let r = await fetch(`https://api.github.com/repos/${currentUser}/${renameTarget}`,{
      method:'PATCH',
      headers:{ 'Authorization':`token ${currentToken}`, 'Content-Type':'application/json' },
      body: JSON.stringify({ name:newName, description:newDesc })
    });
    if(!r.ok) throw new Error('重新命名失敗');
    alert('已重新命名');
    closeRenameModal();
    await loadRepos();
  } catch(e){ alert('錯誤：'+e.message); }
}
async function deleteRepo(n){ if(!confirm(`確定刪除 ${n}？無法還原`)) return; try{ let r=await fetch(`https://api.github.com/repos/${currentUser}/${n}`,{ method:'DELETE', headers:{ 'Authorization':`token ${currentToken}` } }); if(!r.ok) throw new Error('刪除失敗'); alert('已刪除'); await loadRepos(); }catch(e){alert('錯誤：'+e.message);} }
async function enablePages(repo){ try{ let r=await fetch(`https://api.github.com/repos/${currentUser}/${repo}/pages`,{ method:'POST', headers:{ 'Authorization':`token ${currentToken}`,'Content-Type':'application/json' }, body: JSON.stringify({ source:{branch:'main',path:'/'} }) }); if(!r.ok) throw new Error('啟用失敗'); alert('Pages 已啟用'); await loadRepos(); }catch(e){alert('錯誤：'+e.message);} }
function openSite(u){ window.open(u,'_blank'); }

</script>
</body>
</html>
