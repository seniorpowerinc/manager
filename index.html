<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ GitHub Repo ç®¡ç†ç³»çµ±</title>
  <style>
    /* Reset & å…¨ç«™é…è‰² */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg,#667eea,#764ba2);
      color: #333; min-height:100vh; padding:20px;
    }
    .container {
      max-width:1200px; margin:0 auto; background:rgba(255,255,255,0.95);
      border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden;
    }
    .header {
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:#fff; padding:30px; text-align:center;
    }
    .header h1 { font-size:2.5em; font-weight:300; margin-bottom:10px; }
    .header p { font-size:1.1em; opacity:0.9; }

    .main-content { padding:30px; }

    /* æŒ‰éˆ•æ¨£å¼ */
    .btn {
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:#fff; border:none; padding:15px 30px; border-radius:25px;
      font-size:16px; font-weight:600; cursor:pointer; transition:all .3s;
      margin:10px; position:relative; overflow:hidden;
    }
    .btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(79,172,254,.3); }
    .btn:disabled { background:#ccc; cursor:not-allowed; box-shadow:none; }
    .btn.danger  { background: linear-gradient(135deg,#ff6b6b,#ee5a52); }
    .btn.success { background: linear-gradient(135deg,#56ab2f,#a8e6cf); }
    .btn.warning { background: linear-gradient(135deg,#f093fb,#f5576c); }

    /* èªè­‰å€åŸŸ */
    .auth-section {
      background: linear-gradient(135deg,#ffecd2,#fcb69f);
      border-radius:15px; padding:30px; margin-bottom:30px; text-align:center;
    }
    .auth-section.authenticated {
      background: linear-gradient(135deg,#a8edea,#fed6e3);
    }
    .token-input {
      width:100%; max-width:500px; padding:15px; border:2px solid #ddd;
      border-radius:10px; font-size:16px; margin:15px 0; transition:border-color .3s;
    }
    .token-input:focus {
      outline:none; border-color:#4facfe; box-shadow:0 0 10px rgba(79,172,254,.3);
    }
    .user-info {
      background:rgba(255,255,255,.2); border-radius:10px; padding:15px;
      margin:15px 0; display:flex; justify-content:space-between; align-items:center;
    }

    /* ç‹€æ…‹æç¤º */
    .info-box {
      background: linear-gradient(135deg,#e3f2fd,#bbdefb);
      border-left:4px solid #2196f3; border-radius:10px;
      padding:20px; margin-bottom:20px;
    }
    .info-box h4 { color:#1976d2; margin-bottom:10px; }
    .info-box p { line-height:1.6; }

    .permissions-list { padding-left:20px; margin:15px 0; }
    .permissions-list li { margin:5px 0; }

    /* æ–°å¢ Repo è¡¨å–® */
    .add-repo-section {
      background: linear-gradient(135deg,#ffecd2,#fcb69f);
      border-radius:15px; padding:30px; margin-bottom:30px;
    }
    .form-group { margin-bottom:20px; }
    .form-group label { display:block; margin-bottom:8px; font-weight:600; }
    .form-group input,
    .form-group textarea {
      width:100%; padding:12px; border:2px solid #ddd; border-radius:8px;
      font-size:16px; transition:border-color .3s;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline:none; border-color:#4facfe;
    }

    /* Repo å¡ç‰‡ */
    .repos-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
      gap:25px; margin-top:30px;
    }
    .repo-card {
      background:#fff; border-radius:15px; padding:25px;
      box-shadow:0 10px 25px rgba(0,0,0,.1); transition:all .3s;
      border:2px solid transparent;
    }
    .repo-card:hover {
      transform:translateY(-5px); box-shadow:0 20px 40px rgba(0,0,0,.15);
      border-color:#4facfe;
    }
    .repo-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .repo-name { font-size:1.4em; font-weight:600; }
    .repo-url { font-size:0.9em; color:#666; word-break:break-all; margin-bottom:10px; }
    .repo-url a { color:#4facfe; text-decoration:none; }
    .repo-actions { display:flex; gap:10px; flex-wrap:wrap; }

    /* ç‹€æ…‹æŒ‡ç¤º */
    .status-indicator {
      padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600;
    }
    .status-active   { background:#d4edda; color:#155724; }
    .status-inactive { background:#f8d7da; color:#721c24; }

    /* è¼‰å…¥å‹•ç•« */
    .loading {
      display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3;
      border-top:3px solid #4facfe; border-radius:50%; animation:spin 1s linear infinite;
      margin-left:10px;
    }
    @keyframes spin { to{ transform:rotate(360deg); } }

    /* éŸ¿æ‡‰å¼ */
    @media(max-width:768px) {
      .repos-grid { grid-template-columns:1fr; }
      .container { margin:10px; }
    }

    /* æ¨¡æ…‹å°è©±æ¡† */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.5); z-index:1000;
    }
    .modal-content {
      background:#fff; margin:15% auto; padding:30px; border-radius:15px;
      width:90%; max-width:500px; box-shadow:0 20px 40px rgba(0,0,0,.3);
    }
    .modal .close {
      float:right; font-size:28px; font-weight:bold; cursor:pointer; color:#aaa;
    }
    .modal .close:hover { color:#000; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ GitHub Repo ç®¡ç†ç³»çµ±</h1>
      <p>çµ±ä¸€ç®¡ç†æ‚¨çš„ç¦®ç‰©å±•ç¤ºç¶²ç«™</p>
    </div>

    <div class="main-content">
      <!-- èªè­‰å€ -->
      <div id="authSection" class="auth-section">
        <h2>ğŸ” GitHub èªè­‰</h2>
        <div class="info-box">
          <h4>è¨­ç½®èªªæ˜</h4>
          <p>è«‹å‰å¾€ GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens â†’ Tokens (classic) å‰µå»ºæ–°çš„ Token</p>
          <p><strong>éœ€è¦çš„æ¬Šé™ï¼š</strong></p>
          <ul class="permissions-list">
            <li>âœ… <strong>repo</strong> - å®Œæ•´å€‰åº«æ§åˆ¶</li>
            <li>âœ… <strong>delete_repo</strong> - åˆªé™¤å€‰åº«</li>
            <li>âœ… <strong>user</strong> - è®€å–ç”¨æˆ¶è³‡æ–™</li>
          </ul>
        </div>
        <input type="password" id="tokenInput" class="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        <br>
        <button id="loginBtn" class="btn" onclick="authenticate()">ç™»å…¥</button>
        <div id="userInfo" class="user-info hidden">
          <span>å·²ç™»å…¥ç”¨æˆ¶ï¼š<strong id="username"></strong></span>
          <button class="btn danger" onclick="logout()">ç™»å‡º</button>
        </div>
      </div>

      <!-- æ–°å¢ Repo -->
      <div id="addRepoSection" class="add-repo-section hidden">
        <h2>â• æ–°å¢ç¦®ç‰©ç¶²ç«™</h2>
        <div class="form-group">
          <label for="repoName">Repo åç¨±</label>
          <input type="text" id="repoName" placeholder="ä¾‹å¦‚: my-gift-site">
        </div>
        <div class="form-group">
          <label for="repoDescription">æè¿° (å¯é¸)</label>
          <textarea id="repoDescription" rows="3" placeholder="é€™å€‹ç¦®ç‰©ç¶²ç«™çš„æè¿°..."></textarea>
        </div>
        <button id="createRepoBtn" class="btn success" onclick="createRepo()">å‰µå»ºæ–°çš„ç¦®ç‰©ç¶²ç«™</button>
      </div>

      <!-- åˆ—è¡¨ -->
      <div id="reposList" class="hidden">
        <h2>ğŸ“¦ æˆ‘çš„ç¦®ç‰©ç¶²ç«™</h2>
        <div id="reposGrid" class="repos-grid"></div>
      </div>
    </div>
  </div>

  <!-- é‡æ–°å‘½å Modal -->
  <div id="renameModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeRenameModal()">&times;</span>
      <h3>é‡æ–°å‘½å Repo</h3>
      <div class="form-group">
        <label for="newRepoName">æ–°åç¨±</label>
        <input type="text" id="newRepoName">
      </div>
      <div class="form-group">
        <label for="newRepoDescription">æ–°æè¿°</label>
        <textarea id="newRepoDescription" rows="3"></textarea>
      </div>
      <button class="btn success" onclick="confirmRename()">ç¢ºèªé‡æ–°å‘½å</button>
      <button class="btn" onclick="closeRenameModal()">å–æ¶ˆ</button>
    </div>
  </div>

  <script>
    let currentToken = '', currentUser = '', currentRenameRepo = '';

    // ç™»å…¥é©—è­‰
    async function authenticate() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) { alert('è«‹è¼¸å…¥ GitHub Token'); return; }
      const btn = document.getElementById('loginBtn');
      btn.innerHTML = 'é©—è­‰ä¸­...<div class="loading"></div>'; btn.disabled = true;
      try {
        const res = await fetch('https://api.github.com/user', {
          headers: {'Authorization': `token ${token}`, 'Accept':'application/vnd.github.v3+json'}
        });
        if (!res.ok) throw new Error('Token ç„¡æ•ˆæˆ–æ¬Šé™ä¸è¶³');
        const user = await res.json();
        currentToken = token; currentUser = user.login;
        document.getElementById('authSection').classList.add('authenticated');
        document.getElementById('username').textContent = user.login;
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('tokenInput').style.display = 'none';
        btn.style.display = 'none';
        document.getElementById('addRepoSection').classList.remove('hidden');
        document.getElementById('reposList').classList.remove('hidden');
        await loadRepos();
      } catch (e) {
        alert('èªè­‰å¤±æ•—ï¼š' + e.message);
      } finally {
        btn.innerHTML = 'ç™»å…¥'; btn.disabled = false;
      }
    }

    // ç™»å‡º
    function logout() {
      currentToken = ''; currentUser = '';
      document.location.reload();
    }

    // è¼‰å…¥ä¸¦ç¯©é¸ repos
    async function loadRepos() {
      try {
        const res = await fetch(`https://api.github.com/user/repos?per_page=100&sort=updated`, {
          headers: {'Authorization': `token ${currentToken}`, 'Accept':'application/vnd.github.v3+json'}
        });
        if (!res.ok) throw new Error('ç„¡æ³•è¼‰å…¥ repos');
        const list = await res.json(), giftRepos = [];
        for (const r of list) {
          const c = await fetch(`https://api.github.com/repos/${r.full_name}/contents/data.json`, {
            headers: {'Authorization': `token ${currentToken}`, 'Accept':'application/vnd.github.v3+json'}
          });
          if (c.ok) giftRepos.push(r);
        }
        displayRepos(giftRepos);
      } catch (e) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + e.message);
      }
    }

    // é¡¯ç¤º repos
    function displayRepos(repos) {
      const grid = document.getElementById('reposGrid');
      grid.innerHTML = '';
      if (repos.length === 0) {
        grid.innerHTML = '<p style="grid-column:1/-1;color:#666;text-align:center;">é‚„æ²’æœ‰ä»»ä½•ç¦®ç‰©ç¶²ç«™ï¼Œå‰µå»ºç¬¬ä¸€å€‹å§ï¼</p>';
        return;
      }
      repos.forEach(r => {
        const site = `https://${r.owner.login}.github.io/${r.name}/`;
        const active = r.has_pages;
        const card = document.createElement('div'); card.className = 'repo-card';
        card.innerHTML = `
          <div class="repo-header">
            <div class="repo-name">${r.name}</div>
            <div class="status-indicator ${active?'status-active':'status-inactive'}">
              ${active?'ğŸŸ¢ å·²ç™¼å¸ƒ':'ğŸ”´ æœªç™¼å¸ƒ'}
            </div>
          </div>
          <div class="repo-url"><strong>ç¶²ç«™:</strong>
            <a href="${site}" target="_blank">${site}</a>
          </div>
          <div class="repo-url"><strong>æè¿°:</strong> ${r.description||'ç„¡æè¿°'}</div>
          <div class="repo-url"><strong>æ›´æ–°æ™‚é–“:</strong>
            ${new Date(r.updated_at).toLocaleString('zh-TW')}
          </div>
          <div class="repo-actions">
            <button class="btn" onclick="openSite('${site}')">ğŸŒ è¨ªå•ç¶²ç«™</button>
            <button class="btn warning"
                    onclick="openRenameModal('${r.name}','${r.description||''}')">
              âœï¸ é‡æ–°å‘½å
            </button>
            <button class="btn"
                    onclick="enablePages('${r.name}','${r.owner.login}')"
                    ${active?'style="display:none"':''}>
              ğŸ“„ å•Ÿç”¨ Pages
            </button>
            <button class="btn danger" onclick="deleteRepo('${r.name}')">
              ğŸ—‘ï¸ åˆªé™¤
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // å‰µå»º Repo
    async function createRepo() {
      const name = document.getElementById('repoName').value.trim();
      const desc = document.getElementById('repoDescription').value.trim();
      if (!name) { alert('è«‹è¼¸å…¥ repo åç¨±'); return; }
      const btn = document.getElementById('createRepoBtn');
      btn.innerHTML = 'å‰µå»ºä¸­...<div class="loading"></div>'; btn.disabled = true;
      try {
        const r = await fetch('https://api.github.com/user/repos', {
          method:'POST',
          headers:{
            'Authorization':`token ${currentToken}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({
            name, description: desc||`${name} ç¦®ç‰©å±•ç¤ºç¶²ç«™`,
            private:false, auto_init:true
          })
        });
        if (!r.ok) throw new Error((await r.json()).message||'å‰µå»ºå¤±æ•—');
        await new Promise(res=>setTimeout(res,2000));
        await createInitialFiles(name);
        await enablePages(name, currentUser);
        alert('ç¦®ç‰©ç¶²ç«™å‰µå»ºæˆåŠŸï¼');
        document.getElementById('repoName').value='';
        document.getElementById('repoDescription').value='';
        await loadRepos();
      } catch(e) {
        alert('å‰µå»ºå¤±æ•—ï¼š'+e.message);
      } finally {
        btn.innerHTML = 'å‰µå»ºæ–°çš„ç¦®ç‰©ç¶²ç«™'; btn.disabled = false;
      }
    }

    // åˆå§‹æ–‡ä»¶
    async function createInitialFiles(repo) {
      const files = [
        { path:'index.html', content: `<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">GIFT</title>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;
      background:linear-gradient(135deg,#e0f7fa,#bbdefb,#c5cae9);
      font-family:Arial,sans-serif;}
    .main-content{display:flex;align-items:center;justify-content:center;
      flex-direction:column;height:100%;}
    .cover-image{width:80%;max-width:500px;border-radius:10px;
      box-shadow:0 8px 25px rgba(0,0,0,.2);transition:transform .5s,opacity .5s;cursor:pointer;}
    .cover-image:hover{transform:scale(1.05);}
    .lift-open{transform:scale(1.8);opacity:0;}
    .open-button{position:absolute;bottom:60px;left:50%;
      transform:translateX(-50%);background:linear-gradient(145deg,#63BE7B,#FFEF9C);
      color:#000;border:none;padding:12px 30px;font-size:34px;font-weight:bold;
      border-radius:50px;box-shadow:0 5px 15px rgba(255,94,98,.4);cursor:pointer;z-index:3;}
    #pdf-container{display:none;position:fixed;top:5%;left:5%;width:90%;height:90%;
      background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.2);border-radius:8px;overflow:hidden;}
    #pdf-frame{width:100%;height:100%;border:none;}
    #confetti-canvas{position:fixed;top:0;left:0;width:100%;height:100%;
      pointer-events:none;z-index:1001;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="main-content">
    <img id="coverImage" class="cover-image" src="" alt="å°é¢">
    <button id="openButton" class="open-button">é–±è®€</button>
  </div>
  <div id="pdf-container"><iframe id="pdf-frame" src="" loading="lazy"></iframe></div>
  <canvas id="confetti-canvas"></canvas>
  <script>
    let pdfUrl = '';
    fetch('data.json?bust='+Date.now())
      .then(res=>res.json()).then(d=>{
        document.documentElement.lang=d.lang||'zh-TW';
        document.getElementById('pageTitle').textContent=d.pageTitle;
        document.title=d.pageTitle;
        document.getElementById('coverImage').src=d.coverImage;
        pdfUrl = d.pdf;
        document.getElementById('pdf-frame').src = pdfUrl;
      }).catch(console.error);
    const img=document.getElementById('coverImage');
    const btn=document.getElementById('openButton');
    const pdfc=document.getElementById('pdf-container');
    const canvas=document.getElementById('confetti-canvas');
    const conf = confetti.create(canvas,{ resize:true, useWorker:false });
    function openGift(){
      img.classList.add('lift-open');
      btn.style.display='none';
      setTimeout(()=>{
        pdfc.style.display='block';
        conf({particleCount:150,spread:120,origin:{y:0.6}});
      },300);
    }
    btn.addEventListener('click',openGift);
    img.addEventListener('click',openGift);
  </script>
</body>
</html>` },
        { path:'data.json', content: JSON.stringify({
            pageTitle:`${repo} - ç¦®ç‰©`,
            lang:'zh-TW',
            pdf:'',
            coverImage:'https://via.placeholder.com/500x300?text=Welcome+Gift'
          },null,2) },
        { path:'.github/workflows/deploy.yml', content:
`name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: \${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/configure-pages@v3
      - uses: actions/upload-pages-artifact@v2
        with:
          path: '.'
      - id: deployment
        uses: actions/deploy-pages@v2` }
      ];
      // ä¸Šå‚³æ¯å€‹æ–‡ä»¶
      for (const f of files) {
        await uploadFileToRepo(repo, f.path, f.content);
        await new Promise(r=>setTimeout(r,500));
      }
    }

    // ä¸Šå‚³æª”æ¡ˆ
    async function uploadFileToRepo(repo, path, content) {
      const res = await fetch(`https://api.github.com/repos/${currentUser}/${repo}/contents/${path}`, {
        method:'PUT',
        headers:{ 'Authorization':`token ${currentToken}`, 'Content-Type':'application/json' },
        body: JSON.stringify({
          message:`Add ${path}`,
          content: btoa(unescape(encodeURIComponent(content)))
        })
      });
      if (!res.ok) throw new Error(`ä¸Šå‚³ ${path} å¤±æ•—`);
    }

    // é‡æ–°å‘½å
    function openRenameModal(name, desc) {
      currentRenameRepo = name;
      document.getElementById('newRepoName').value = name;
      document.getElementById('newRepoDescription').value = desc;
      document.getElementById('renameModal').style.display = 'block';
    }
    function closeRenameModal() {
      document.getElementById('renameModal').style.display = 'none';
    }
    async function confirmRename() {
      const newName = document.getElementById('newRepoName').value.trim();
      const newDesc = document.getElementById('newRepoDescription').value.trim();
      if (!newName) { alert('è«‹è¼¸å…¥æ–°åç¨±'); return; }
      try {
        const res = await fetch(`https://api.github.com/repos/${currentUser}/${currentRenameRepo}`, {
          method:'PATCH',
          headers:{
            'Authorization':`token ${currentToken}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ name:newName, description:newDesc })
        });
        if (!res.ok) throw new Error('é‡æ–°å‘½åå¤±æ•—');
        alert('é‡æ–°å‘½åæˆåŠŸ');
        closeRenameModal();
        await loadRepos();
      } catch(e) {
        alert('éŒ¯èª¤ï¼š'+e.message);
      }
    }

    // åˆªé™¤
    async function deleteRepo(name) {
      if (!confirm(`ç¢ºå®šè¦åˆªé™¤ ${name} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•é‚„åŸï¼`)) return;
      try {
        const res = await fetch(`https://api.github.com/repos/${currentUser}/${name}`, {
          method:'DELETE',
          headers:{ 'Authorization':`token ${currentToken}` }
        });
        if (!res.ok) throw new Error('åˆªé™¤å¤±æ•—');
        alert('åˆªé™¤æˆåŠŸ');
        await loadRepos();
      } catch(e) {
        alert('éŒ¯èª¤ï¼š'+e.message);
      }
    }

    // å•Ÿç”¨ Pages
    async function enablePages(repo, owner) {
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/pages`, {
          method:'POST',
          headers:{
            'Authorization':`token ${currentToken}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ source:{ branch:'main', path:'/' }})
        });
        if (!res.ok) throw new Error('å•Ÿç”¨ Pages å¤±æ•—');
        alert('Pages å·²å•Ÿç”¨');
        await loadRepos();
      } catch(e) {
        alert('éŒ¯èª¤ï¼š'+e.message);
      }
    }

    // é–‹æ–°åˆ†é 
    function openSite(url) {
      window.open(url,'_blank');
    }
  </script>
</body>
</html>
