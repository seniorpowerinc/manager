<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Repo 管理系統</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 300;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .main-content {
      padding: 30px;
    }

    /* 登入區域 */
    .auth-section {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }

    .auth-section.authenticated {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    .token-input {
      width: 100%;
      max-width: 500px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      margin: 15px 0;
      transition: border-color 0.3s;
    }

    .token-input:focus {
      outline: none;
      border-color: #4facfe;
      box-shadow: 0 0 10px rgba(79, 172, 254, 0.3);
    }

    .btn {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin: 10px;
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 172, 254, 0.3);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn.danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
    }

    .btn.success {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    }

    /* Repo 網格 */
    .repos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .repo-card {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .repo-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      border-color: #4facfe;
    }

    .repo-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 15px;
    }

    .repo-name {
      font-size: 1.4em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .repo-url {
      font-size: 0.9em;
      color: #666;
      word-break: break-all;
      margin-bottom: 15px;
    }

    .repo-url a {
      color: #4facfe;
      text-decoration: none;
    }

    .repo-url a:hover {
      text-decoration: underline;
    }

    .repo-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .repo-actions .btn {
      font-size: 14px;
      padding: 10px 20px;
      margin: 0;
    }

    /* 新增 Repo 表單 */
    .add-repo-section {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #4facfe;
    }

    /* 載入動畫 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #4facfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* 狀態指示器 */
    .status-indicator {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 10px;
    }

    .status-active {
      background: #d4edda;
      color: #155724;
    }

    .status-inactive {
      background: #f8d7da;
      color: #721c24;
    }

    /* 響應式設計 */
    @media (max-width: 768px) {
      .container {
        margin: 10px;
        border-radius: 15px;
      }

      .main-content {
        padding: 20px;
      }

      .repos-grid {
        grid-template-columns: 1fr;
      }

      .repo-actions {
        justify-content: center;
      }
    }

    /* 隱藏/顯示區域 */
    .hidden {
      display: none;
    }

    .user-info {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }

    .user-info strong {
      color: #333;
    }

    /* 進度條 */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #eee;
      border-radius: 3px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #4facfe, #00f2fe);
      width: 0%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎁 GitHub Repo 管理系統</h1>
      <p>統一管理您的禮物展示網站</p>
    </div>

    <div class="main-content">
      <!-- 認證區域 -->
      <div id="authSection" class="auth-section">
        <h2>🔐 GitHub 認證</h2>
        <p>請輸入您的 GitHub Personal Access Token</p>
        <input type="password" id="tokenInput" class="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        <br>
        <button id="loginBtn" class="btn" onclick="authenticate()">登入</button>
        
        <div id="userInfo" class="user-info hidden">
          <strong>已登入用戶：</strong> <span id="username"></span>
          <button class="btn danger" onclick="logout()" style="float: right;">登出</button>
        </div>
      </div>

      <!-- 新增 Repo 區域 -->
      <div id="addRepoSection" class="add-repo-section hidden">
        <h2>➕ 新增禮物網站</h2>
        <div class="form-group">
          <label for="repoName">Repo 名稱</label>
          <input type="text" id="repoName" placeholder="例如: my-gift-site">
        </div>
        <div class="form-group">
          <label for="repoDescription">描述 (可選)</label>
          <textarea id="repoDescription" placeholder="這個禮物網站的描述..." rows="3"></textarea>
        </div>
        <button id="createRepoBtn" class="btn success" onclick="createRepo()">創建新的禮物網站</button>
      </div>

      <!-- Repos 列表 -->
      <div id="reposList" class="hidden">
        <h2>📦 我的禮物網站</h2>
        <div id="reposGrid" class="repos-grid">
          <!-- Repos 將動態載入到這裡 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentToken = '';
    let currentUser = '';
    
    // 認證函數
    async function authenticate() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        alert('請輸入 GitHub Token');
        return;
      }

      const loginBtn = document.getElementById('loginBtn');
      loginBtn.innerHTML = '驗證中...<div class="loading"></div>';
      loginBtn.disabled = true;

      try {
        const response = await fetch('https://api.github.com/user', {
          headers: {
            'Authorization': `token ${token}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error('Token 無效');
        }

        const userData = await response.json();
        currentToken = token;
        currentUser = userData.login;

        // 更新 UI
        document.getElementById('authSection').classList.add('authenticated');
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('username').textContent = userData.login;
        document.getElementById('addRepoSection').classList.remove('hidden');
        document.getElementById('reposList').classList.remove('hidden');
        document.getElementById('tokenInput').style.display = 'none';
        loginBtn.style.display = 'none';

        await loadRepos();
        
      } catch (error) {
        alert('認證失敗: ' + error.message);
      } finally {
        loginBtn.innerHTML = '登入';
        loginBtn.disabled = false;
      }
    }

    // 登出函數
    function logout() {
      currentToken = '';
      currentUser = '';
      
      document.getElementById('authSection').classList.remove('authenticated');
      document.getElementById('userInfo').classList.add('hidden');
      document.getElementById('addRepoSection').classList.add('hidden');
      document.getElementById('reposList').classList.add('hidden');
      document.getElementById('tokenInput').style.display = 'block';
      document.getElementById('tokenInput').value = '';
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('reposGrid').innerHTML = '';
    }

    // 載入 repos
    async function loadRepos() {
      try {
        const response = await fetch(`https://api.github.com/user/repos?per_page=100&sort=updated`, {
          headers: {
            'Authorization': `token ${currentToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) throw new Error('無法載入 repos');

        const repos = await response.json();
        
        // 過濾出包含禮物網站的 repos (檢查是否有 data.json)
        const giftRepos = [];
        
        for (const repo of repos) {
          try {
            const contentResponse = await fetch(`https://api.github.com/repos/${repo.full_name}/contents/data.json`, {
              headers: {
                'Authorization': `token ${currentToken}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            });
            
            if (contentResponse.ok) {
              giftRepos.push(repo);
            }
          } catch (e) {
            // 忽略沒有 data.json 的 repos
          }
        }

        displayRepos(giftRepos);
        
      } catch (error) {
        console.error('載入 repos 失敗:', error);
        alert('載入 repos 失敗: ' + error.message);
      }
    }

    // 顯示 repos
    function displayRepos(repos) {
      const grid = document.getElementById('reposGrid');
      grid.innerHTML = '';

      if (repos.length === 0) {
        grid.innerHTML = '<p style="text-align: center; grid-column: 1/-1; color: #666;">還沒有任何禮物網站，創建第一個吧！</p>';
        return;
      }

      repos.forEach(repo => {
        const card = document.createElement('div');
        card.className = 'repo-card';
        
        const siteUrl = `https://${repo.owner.login}.github.io/${repo.name}/`;
        const isActive = repo.has_pages; // GitHub Pages 是否啟用
        
        card.innerHTML = `
          <div class="repo-header">
            <div class="repo-name">${repo.name}</div>
            <div class="status-indicator ${isActive ? 'status-active' : 'status-inactive'}">
              ${isActive ? '🟢 已發布' : '🔴 未發布'}
            </div>
          </div>
          <div class="repo-url">
            <strong>網站:</strong> <a href="${siteUrl}" target="_blank">${siteUrl}</a>
          </div>
          <div class="repo-url">
            <strong>描述:</strong> ${repo.description || '無描述'}
          </div>
          <div class="repo-url">
            <strong>更新時間:</strong> ${new Date(repo.updated_at).toLocaleString('zh-TW')}
          </div>
          <div class="repo-actions">
            <button class="btn" onclick="openSite('${siteUrl}')">🌐 訪問網站</button>
            <button class="btn" onclick="manageRepo('${repo.name}')">⚙️ 管理內容</button>
            <button class="btn" onclick="enablePages('${repo.name}', '${repo.owner.login}')" ${isActive ? 'style="display:none"' : ''}>📄 啟用 Pages</button>
            <button class="btn danger" onclick="deleteRepo('${repo.name}')">🗑️ 刪除</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    // 創建新的 repo
    async function createRepo() {
      const repoName = document.getElementById('repoName').value.trim();
      const repoDescription = document.getElementById('repoDescription').value.trim();
      
      if (!repoName) {
        alert('請輸入 repo 名稱');
        return;
      }

      const createBtn = document.getElementById('createRepoBtn');
      createBtn.innerHTML = '創建中...<div class="loading"></div>';
      createBtn.disabled = true;

      try {
        // 1. 創建 repo
        const repoResponse = await fetch('https://api.github.com/user/repos', {
          method: 'POST',
          headers: {
            'Authorization': `token ${currentToken}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github.v3+json'
          },
          body: JSON.stringify({
            name: repoName,
            description: repoDescription || `${repoName} 禮物展示網站`,
            private: false,
            auto_init: true
          })
        });

        if (!repoResponse.ok) {
          const error = await repoResponse.json();
          throw new Error(error.message || '創建 repo 失敗');
        }

        const repoData = await repoResponse.json();

        // 2. 等待 repo 初始化完成
        await new Promise(resolve => setTimeout(resolve, 2000));

        // 3. 創建基本文件
        await createInitialFiles(repoName);

        // 4. 啟用 GitHub Pages
        await enableGitHubPages(repoName);

        alert('禮物網站創建成功！');
        document.getElementById('repoName').value = '';
        document.getElementById('repoDescription').value = '';
        
        await loadRepos();
        
      } catch (error) {
        alert('創建失敗: ' + error.message);
      } finally {
        createBtn.innerHTML = '創建新的禮物網站';
        createBtn.disabled = false;
      }
    }

    // 創建初始文件
    async function createInitialFiles(repoName) {
      const files = [
        {
          path: 'index.html',
          content: `<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <title id="pageTitle">GIFT</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden;
      background: linear-gradient(135deg, #e0f7fa, #bbdefb, #c5cae9);
      font-family: Arial, sans-serif; }
    .main-content { display:flex; flex-direction:column; align-items:center;
      justify-content:center; width:100%; max-width:800px; margin:0 auto; padding:40px 0; }
    .cover-image { width:90vw; max-width:500px; border-radius:10px;
      box-shadow:0 8px 25px rgba(0,0,0,0.2); transition:transform .5s, opacity .5s;
      cursor:pointer; }
    .cover-image:hover { transform:scale(1.05); }
    .lift-open { transform:scale(1.8); opacity:0; }
    .open-button { position:absolute; bottom:60px; left:50%; transform:translateX(-50%);
      background:linear-gradient(145deg,#63BE7B,#FFEF9C); color:black; border:none;
      padding:12px 30px; font-size:34px; font-weight:bold; border-radius:50px;
      box-shadow:0 5px 15px rgba(255,94,98,0.4); cursor:pointer; z-index:3; }
    @media(max-width:768px){ .open-button{font-size:28px;padding:10px 24px;bottom:40px;} }
    #pdf-container { display:none; position:fixed; top:5%; left:5%;
      width:90%; height:90%; background:#fff; overflow:hidden;
      box-shadow:0 4px 20px rgba(0,0,0,0.2); border-radius:8px; }
    #pdf-frame { width:100%; height:100%; border:none; }
    #confetti-canvas { position:fixed; top:0; left:0; width:100%; height:100%;
      pointer-events:none; z-index:1001; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="main-content">
    <div style="position:relative;">
      <img id="coverImage" class="cover-image" src="" alt="封面">
      <button id="openButton" class="open-button">閱讀</button>
    </div>
  </div>

  <div id="pdf-container">
    <iframe id="pdf-frame" src="" allow="autoplay; encrypted-media" loading="lazy"></iframe>
  </div>

  <canvas id="confetti-canvas"></canvas>
  <audio id="celebration-sound" src="images/open.mp3" preload="auto"></audio>
  <script>
    let windowPdfUrl = '';
    fetch('data.json?bust=' + Date.now())
      .then(res => res.json())
      .then(d => {
        document.documentElement.lang = d.lang || 'zh-TW';
        document.getElementById('pageTitle').textContent = d.pageTitle || 'GIFT';
        document.title = d.pageTitle || document.title;
        document.getElementById('coverImage').src = d.coverImage || 'https://via.placeholder.com/500x300?text=Gift';
        if (d.pdf) {
          windowPdfUrl = d.pdf.replace('/view?usp=sharing', '/preview');
        }
        document.getElementById('pdf-frame').src = windowPdfUrl;
      })
      .catch(console.error);

    const btn = document.getElementById('openButton');
    const img = document.getElementById('coverImage');
    const pdfContainer = document.getElementById('pdf-container');
    const canvas = document.getElementById('confetti-canvas');
    const myConfetti = confetti.create(canvas, { resize:true, useWorker:false });
    const sound = document.getElementById('celebration-sound');

    function openGift() {
      img.classList.add('lift-open');
      btn.style.display = 'none';
      setTimeout(() => {
        pdfContainer.style.display = 'block';
        try { 
          myConfetti({ particleCount:150, spread:120, origin:{ y:0.6 } }); 
        } catch(e) { 
          console.log('confetti suppressed'); 
        }
      }, 300);
    }
    btn.addEventListener('click', e => { e.stopPropagation(); openGift(); });
    img.addEventListener('click', openGift);
    img.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') openGift(); });
  </script>
</body>
</html>`
        },
        {
          path: 'data.json',
          content: JSON.stringify({
            pageTitle: `${repoName} - 禮物`,
            lang: "zh-TW",
            pdf: "",
            coverImage: "https://via.placeholder.com/500x300?text=Welcome+Gift"
          }, null, 2)
        },
        {
          path: '.github/workflows/deploy.yml',
          content: `name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: \${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Pages
        uses: actions/configure-pages@v3
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2`
        }
      ];

      for (const file of files) {
        await uploadFileToRepo(repoName, file.path, file.content);
        await new Promise(resolve => setTimeout(resolve, 500)); // 避免 API 限制
      }
    }

    // 上傳文件到 repo
    async function uploadFileToRepo(repoName, filePath, content) {
      const response = await fetch(`https://api.github.com/repos/${currentUser}/${repoName}/contents/${filePath}`, {
        method: 'PUT',
        headers: {
          'Authorization': `token ${currentToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Add ${filePath}`,
          content: btoa(unescape(encodeURIComponent(content)))
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`上傳 ${filePath} 失敗: ${error.message}`);
      }
    }

    // 啟用 GitHub Pages
    async function enableGitHubPages(repoName) {
      try {
        const response = await fetch(`https://api.github.com/repos/${currentUser}/${repoName}/pages`, {
          method: 'POST',
          headers: {
            'Authorization': `token ${currentToken}`,
            'Content-Type': 'application/json',
            'Accept': 'application/vnd.github+json'
          },
          body: JSON.stringify({
            source: {
              branch: 'main',
              path: '/'
            }
          })
        });

        if (!response.ok && response.status !== 409) { // 409 表示已經啟用
          throw new Error('啟用 Pages 失敗');
        }
      } catch (error) {
        console.warn('啟用 GitHub Pages 失敗:', error);
      }
    }

    // 單獨啟用 Pages (用於已存在的 repo)
    async function enablePages(repoName, owner) {
      try {
        await enableGitHubPages(repoName);
        alert('GitHub Pages 已啟用！');
        await loadRepos();
      } catch (error) {
        alert('啟用 Pages 失敗: ' + error.message);
      }
    }

    // 打開網站
    function openSite(url) {
      window.open(url, '_blank');
    }

    // 管理 repo 內容 (跳轉到個別的管理頁面)
    function manageRepo(repoName) {
      const manageUrl = `https://${currentUser}.github.io/${repoName}/manage.html`;
      window.open(manageUrl, '_blank');
    }

    // 刪除 repo
    async function deleteRepo(repoName) {
      if (!confirm(`確定要刪除 "${repoName}" 嗎？這個操作無法復原！`)) {
        return;
      }

      if (!confirm(`再次確認：您即將永久刪除 "${repoName}" 及其所有內容！`)) {
        return;
      }

      try {
        const response = await fetch(`https://api.github.com/repos/${currentUser}/${repoName}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `token ${currentToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error('刪除失敗');
        }

        alert('repo 已刪除');
        await loadRepos();
        
      } catch (error) {
        alert('刪除失敗: ' + error.message);
      }
    }

    // 頁面載入時檢查是否有儲存的 token
    document.addEventListener('DOMContentLoaded', () => {
      // 為了安全，不自動儲存 token
      document.getElementById('tokenInput').focus();
    });

    // Enter 鍵登入
    document.getElementById('tokenInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        authenticate();
      }
    });
  </script>
</body>
</html>
