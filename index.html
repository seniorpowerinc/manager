<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🎁 GitHub Repo 管理系統</title>
  <style>
    /* Reset & 全站配色 */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg,#667eea,#764ba2);
      color: #333; min-height:100vh; padding:20px;
    }
    .container {
      max-width:1200px; margin:0 auto; background:rgba(255,255,255,0.95);
      border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,0.1); overflow:hidden;
    }
    .header {
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:#fff; padding:30px; text-align:center;
    }
    .header h1 { font-size:2.5em; font-weight:300; margin-bottom:10px; }
    .header p { font-size:1.1em; opacity:0.9; }

    .main-content { padding:30px; }

    /* 按鈕樣式 */
    .btn {
      background: linear-gradient(135deg,#4facfe,#00f2fe);
      color:#fff; border:none; padding:15px 30px; border-radius:25px;
      font-size:16px; font-weight:600; cursor:pointer; transition:all .3s;
      margin:10px; position:relative; overflow:hidden;
    }
    .btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(79,172,254,.3); }
    .btn:disabled { background:#ccc; cursor:not-allowed; box-shadow:none; }
    .btn.danger  { background: linear-gradient(135deg,#ff6b6b,#ee5a52); }
    .btn.success { background: linear-gradient(135deg,#56ab2f,#a8e6cf); }
    .btn.warning { background: linear-gradient(135deg,#f093fb,#f5576c); }

    /* 認證區域 */
    .auth-section {
      background: linear-gradient(135deg,#ffecd2,#fcb69f);
      border-radius:15px; padding:30px; margin-bottom:30px; text-align:center;
    }
    .auth-section.authenticated {
      background: linear-gradient(135deg,#a8edea,#fed6e3);
    }
    .token-input {
      width:100%; max-width:500px; padding:15px; border:2px solid #ddd;
      border-radius:10px; font-size:16px; margin:15px 0; transition:border-color .3s;
    }
    .token-input:focus {
      outline:none; border-color:#4facfe; box-shadow:0 0 10px rgba(79,172,254,.3);
    }
    .user-info {
      background:rgba(255,255,255,.2); border-radius:10px; padding:15px;
      margin:15px 0; display:flex; justify-content:space-between; align-items:center;
    }

    /* 狀態提示 */
    .info-box {
      background: linear-gradient(135deg,#e3f2fd,#bbdefb);
      border-left:4px solid #2196f3; border-radius:10px;
      padding:20px; margin-bottom:20px;
    }
    .info-box h4 { color:#1976d2; margin-bottom:10px; }
    .info-box p { line-height:1.6; }

    .permissions-list { padding-left:20px; margin:15px 0; }
    .permissions-list li { margin:5px 0; }

    /* 新增 Repo 表單 */
    .add-repo-section {
      background: linear-gradient(135deg,#ffecd2,#fcb69f);
      border-radius:15px; padding:30px; margin-bottom:30px;
    }
    .form-group { margin-bottom:20px; }
    .form-group label { display:block; margin-bottom:8px; font-weight:600; }
    .form-group input,
    .form-group textarea {
      width:100%; padding:12px; border:2px solid #ddd; border-radius:8px;
      font-size:16px; transition:border-color .3s;
    }
    .form-group input:focus,
    .form-group textarea:focus {
      outline:none; border-color:#4facfe;
    }

    /* Repo 卡片 */
    .repos-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
      gap:25px; margin-top:30px;
    }
    .repo-card {
      background:#fff; border-radius:15px; padding:25px;
      box-shadow:0 10px 25px rgba(0,0,0,.1); transition:all .3s;
      border:2px solid transparent;
    }
    .repo-card:hover {
      transform:translateY(-5px); box-shadow:0 20px 40px rgba(0,0,0,.15);
      border-color:#4facfe;
    }
    .repo-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .repo-name { font-size:1.4em; font-weight:600; }
    .repo-url { font-size:0.9em; color:#666; word-break:break-all; margin-bottom:10px; }
    .repo-url a { color:#4facfe; text-decoration:none; }
    .repo-actions { display:flex; gap:10px; flex-wrap:wrap; }

    /* 狀態指示 */
    .status-indicator {
      padding:4px 12px; border-radius:20px; font-size:12px; font-weight:600;
    }
    .status-active   { background:#d4edda; color:#155724; }
    .status-inactive { background:#f8d7da; color:#721c24; }

    /* 載入動畫 */
    .loading {
      display:inline-block; width:20px; height:20px; border:3px solid #f3f3f3;
      border-top:3px solid #4facfe; border-radius:50%; animation:spin 1s linear infinite;
      margin-left:10px;
    }
    @keyframes spin { to{ transform:rotate(360deg); } }

    /* 響應式 */
    @media(max-width:768px) {
      .repos-grid { grid-template-columns:1fr; }
      .container { margin:10px; }
    }

    /* 模態對話框 */
    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,.5); z-index:1000;
    }
    .modal-content {
      background:#fff; margin:15% auto; padding:30px; border-radius:15px;
      width:90%; max-width:500px; box-shadow:0 20px 40px rgba(0,0,0,.3);
    }
    .modal .close {
      float:right; font-size:28px; font-weight:bold; cursor:pointer; color:#aaa;
    }
    .modal .close:hover { color:#000; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎁 GitHub Repo 管理系統</h1>
      <p>統一管理您的禮物展示網站</p>
    </div>

    <div class="main-content">
      <!-- 認證區 -->
      <div id="authSection" class="auth-section">
        <h2>🔐 GitHub 認證</h2>
        <div class="info-box">
          <h4>設置說明</h4>
          <p>請前往 GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic) 創建新的 Token</p>
          <p><strong>需要的權限：</strong></p>
          <ul class="permissions-list">
            <li>✅ <strong>repo</strong> - 完整倉庫控制</li>
            <li>✅ <strong>delete_repo</strong> - 刪除倉庫</li>
            <li>✅ <strong>user</strong> - 讀取用戶資料</li>
          </ul>
        </div>
        <input type="password" id="tokenInput" class="token-input" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
        <br>
        <button id="loginBtn" class="btn" onclick="authenticate()">登入</button>
        <div id="userInfo" class="user-info hidden">
          <span>已登入用戶：<strong id="username"></strong></span>
          <button class="btn danger" onclick="logout()">登出</button>
        </div>
      </div>

      <!-- 新增 Repo -->
      <div id="addRepoSection" class="add-repo-section hidden">
        <h2>➕ 新增禮物網站</h2>
        <div class="form-group">
          <label for="repoName">Repo 名稱</label>
          <input type="text" id="repoName" placeholder="例如: my-gift-site">
        </div>
        <div class="form-group">
          <label for="repoDescription">描述 (可選)</label>
          <textarea id="repoDescription" rows="3" placeholder="這個禮物網站的描述..."></textarea>
        </div>
        <button id="createRepoBtn" class="btn success" onclick="createRepo()">創建新的禮物網站</button>
      </div>

      <!-- 列表 -->
      <div id="reposList" class="hidden">
        <h2>📦 我的禮物網站</h2>
        <div id="reposGrid" class="repos-grid"></div>
      </div>
    </div>
  </div>

  <!-- 重新命名 Modal -->
  <div id="renameModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeRenameModal()">&times;</span>
      <h3>重新命名 Repo</h3>
      <div class="form-group">
        <label for="newRepoName">新名稱</label>
        <input type="text" id="newRepoName">
      </div>
      <div class="form-group">
        <label for="newRepoDescription">新描述</label>
        <textarea id="newRepoDescription" rows="3"></textarea>
      </div>
      <button class="btn success" onclick="confirmRename()">確認重新命名</button>
      <button class="btn" onclick="closeRenameModal()">取消</button>
    </div>
  </div>

  <script>
    let currentToken = '', currentUser = '', currentRenameRepo = '';

    // 登入驗證
    async function authenticate() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) { alert('請輸入 GitHub Token'); return; }
      const btn = document.getElementById('loginBtn');
      btn.innerHTML = '驗證中...<div class="loading"></div>'; btn.disabled = true;
      try {
        const res = await fetch('https://api.github.com/user', {
          headers: {'Authorization': `token ${token}`, 'Accept':'application/vnd.github.v3+json'}
        });
        if (!res.ok) throw new Error('Token 無效或權限不足');
        const user = await res.json();
        currentToken = token; currentUser = user.login;
        document.getElementById('authSection').classList.add('authenticated');
        document.getElementById('username').textContent = user.login;
        document.getElementById('userInfo').classList.remove('hidden');
        document.getElementById('tokenInput').style.display = 'none';
        btn.style.display = 'none';
        document.getElementById('addRepoSection').classList.remove('hidden');
        document.getElementById('reposList').classList.remove('hidden');
        await loadRepos();
      } catch (e) {
        alert('認證失敗：' + e.message);
      } finally {
        btn.innerHTML = '登入'; btn.disabled = false;
      }
    }

    // 登出
    function logout() {
      currentToken = ''; currentUser = '';
      document.location.reload();
    }

    // 載入並篩選 repos
    async function loadRepos() {
      try {
        const res = await fetch(`https://api.github.com/user/repos?per_page=100&sort=updated`, {
          headers: {'Authorization': `token ${currentToken}`, 'Accept':'application/vnd.github.v3+json'}
        });
        if (!res.ok) throw new Error('無法載入 repos');
        const list = await res.json(), giftRepos = [];
        for (const r of list) {
          const c = await fetch(`https://api.github.com/repos/${r.full_name}/contents/data.json`, {
            headers: {'Authorization': `token ${currentToken}`, 'Accept':'application/vnd.github.v3+json'}
          });
          if (c.ok) giftRepos.push(r);
        }
        displayRepos(giftRepos);
      } catch (e) {
        alert('載入失敗：' + e.message);
      }
    }

    // 顯示 repos
    function displayRepos(repos) {
      const grid = document.getElementById('reposGrid');
      grid.innerHTML = '';
      if (repos.length === 0) {
        grid.innerHTML = '<p style="grid-column:1/-1;color:#666;text-align:center;">還沒有任何禮物網站，創建第一個吧！</p>';
        return;
      }
      repos.forEach(r => {
        const site = `https://${r.owner.login}.github.io/${r.name}/`;
        const active = r.has_pages;
        const card = document.createElement('div'); card.className = 'repo-card';
        card.innerHTML = `
          <div class="repo-header">
            <div class="repo-name">${r.name}</div>
            <div class="status-indicator ${active?'status-active':'status-inactive'}">
              ${active?'🟢 已發布':'🔴 未發布'}
            </div>
          </div>
          <div class="repo-url"><strong>網站:</strong>
            <a href="${site}" target="_blank">${site}</a>
          </div>
          <div class="repo-url"><strong>描述:</strong> ${r.description||'無描述'}</div>
          <div class="repo-url"><strong>更新時間:</strong>
            ${new Date(r.updated_at).toLocaleString('zh-TW')}
          </div>
          <div class="repo-actions">
            <button class="btn" onclick="openSite('${site}')">🌐 訪問網站</button>
            <button class="btn warning"
                    onclick="openRenameModal('${r.name}','${r.description||''}')">
              ✏️ 重新命名
            </button>
            <button class="btn"
                    onclick="enablePages('${r.name}','${r.owner.login}')"
                    ${active?'style="display:none"':''}>
              📄 啟用 Pages
            </button>
            <button class="btn danger" onclick="deleteRepo('${r.name}')">
              🗑️ 刪除
            </button>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // 創建 Repo
    async function createRepo() {
      const name = document.getElementById('repoName').value.trim();
      const desc = document.getElementById('repoDescription').value.trim();
      if (!name) { alert('請輸入 repo 名稱'); return; }
      const btn = document.getElementById('createRepoBtn');
      btn.innerHTML = '創建中...<div class="loading"></div>'; btn.disabled = true;
      try {
        const r = await fetch('https://api.github.com/user/repos', {
          method:'POST',
          headers:{
            'Authorization':`token ${currentToken}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({
            name, description: desc||`${name} 禮物展示網站`,
            private:false, auto_init:true
          })
        });
        if (!r.ok) throw new Error((await r.json()).message||'創建失敗');
        await new Promise(res=>setTimeout(res,2000));
        await createInitialFiles(name);
        await enablePages(name, currentUser);
        alert('禮物網站創建成功！');
        document.getElementById('repoName').value='';
        document.getElementById('repoDescription').value='';
        await loadRepos();
      } catch(e) {
        alert('創建失敗：'+e.message);
      } finally {
        btn.innerHTML = '創建新的禮物網站'; btn.disabled = false;
      }
    }

    // 初始文件
    async function createInitialFiles(repo) {
      const files = [
        { path:'index.html', content: `<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">GIFT</title>
  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;overflow:hidden;
      background:linear-gradient(135deg,#e0f7fa,#bbdefb,#c5cae9);
      font-family:Arial,sans-serif;}
    .main-content{display:flex;align-items:center;justify-content:center;
      flex-direction:column;height:100%;}
    .cover-image{width:80%;max-width:500px;border-radius:10px;
      box-shadow:0 8px 25px rgba(0,0,0,.2);transition:transform .5s,opacity .5s;cursor:pointer;}
    .cover-image:hover{transform:scale(1.05);}
    .lift-open{transform:scale(1.8);opacity:0;}
    .open-button{position:absolute;bottom:60px;left:50%;
      transform:translateX(-50%);background:linear-gradient(145deg,#63BE7B,#FFEF9C);
      color:#000;border:none;padding:12px 30px;font-size:34px;font-weight:bold;
      border-radius:50px;box-shadow:0 5px 15px rgba(255,94,98,.4);cursor:pointer;z-index:3;}
    #pdf-container{display:none;position:fixed;top:5%;left:5%;width:90%;height:90%;
      background:#fff;box-shadow:0 4px 20px rgba(0,0,0,.2);border-radius:8px;overflow:hidden;}
    #pdf-frame{width:100%;height:100%;border:none;}
    #confetti-canvas{position:fixed;top:0;left:0;width:100%;height:100%;
      pointer-events:none;z-index:1001;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
  <div class="main-content">
    <img id="coverImage" class="cover-image" src="" alt="封面">
    <button id="openButton" class="open-button">閱讀</button>
  </div>
  <div id="pdf-container"><iframe id="pdf-frame" src="" loading="lazy"></iframe></div>
  <canvas id="confetti-canvas"></canvas>
  <script>
    let pdfUrl = '';
    fetch('data.json?bust='+Date.now())
      .then(res=>res.json()).then(d=>{
        document.documentElement.lang=d.lang||'zh-TW';
        document.getElementById('pageTitle').textContent=d.pageTitle;
        document.title=d.pageTitle;
        document.getElementById('coverImage').src=d.coverImage;
        pdfUrl = d.pdf;
        document.getElementById('pdf-frame').src = pdfUrl;
      }).catch(console.error);
    const img=document.getElementById('coverImage');
    const btn=document.getElementById('openButton');
    const pdfc=document.getElementById('pdf-container');
    const canvas=document.getElementById('confetti-canvas');
    const conf = confetti.create(canvas,{ resize:true, useWorker:false });
    function openGift(){
      img.classList.add('lift-open');
      btn.style.display='none';
      setTimeout(()=>{
        pdfc.style.display='block';
        conf({particleCount:150,spread:120,origin:{y:0.6}});
      },300);
    }
    btn.addEventListener('click',openGift);
    img.addEventListener('click',openGift);
  </script>
</body>
</html>` },
        { path:'data.json', content: JSON.stringify({
            pageTitle:`${repo} - 禮物`,
            lang:'zh-TW',
            pdf:'',
            coverImage:'https://via.placeholder.com/500x300?text=Welcome+Gift'
          },null,2) },
        { path:'.github/workflows/deploy.yml', content:
`name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    environment:
      name: github-pages
      url: \${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/configure-pages@v3
      - uses: actions/upload-pages-artifact@v2
        with:
          path: '.'
      - id: deployment
        uses: actions/deploy-pages@v2` }
      ];
      // 上傳每個文件
      for (const f of files) {
        await uploadFileToRepo(repo, f.path, f.content);
        await new Promise(r=>setTimeout(r,500));
      }
    }

    // 上傳檔案
    async function uploadFileToRepo(repo, path, content) {
      const res = await fetch(`https://api.github.com/repos/${currentUser}/${repo}/contents/${path}`, {
        method:'PUT',
        headers:{ 'Authorization':`token ${currentToken}`, 'Content-Type':'application/json' },
        body: JSON.stringify({
          message:`Add ${path}`,
          content: btoa(unescape(encodeURIComponent(content)))
        })
      });
      if (!res.ok) throw new Error(`上傳 ${path} 失敗`);
    }

    // 重新命名
    function openRenameModal(name, desc) {
      currentRenameRepo = name;
      document.getElementById('newRepoName').value = name;
      document.getElementById('newRepoDescription').value = desc;
      document.getElementById('renameModal').style.display = 'block';
    }
    function closeRenameModal() {
      document.getElementById('renameModal').style.display = 'none';
    }
    async function confirmRename() {
      const newName = document.getElementById('newRepoName').value.trim();
      const newDesc = document.getElementById('newRepoDescription').value.trim();
      if (!newName) { alert('請輸入新名稱'); return; }
      try {
        const res = await fetch(`https://api.github.com/repos/${currentUser}/${currentRenameRepo}`, {
          method:'PATCH',
          headers:{
            'Authorization':`token ${currentToken}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ name:newName, description:newDesc })
        });
        if (!res.ok) throw new Error('重新命名失敗');
        alert('重新命名成功');
        closeRenameModal();
        await loadRepos();
      } catch(e) {
        alert('錯誤：'+e.message);
      }
    }

    // 刪除
    async function deleteRepo(name) {
      if (!confirm(`確定要刪除 ${name} 嗎？此操作無法還原！`)) return;
      try {
        const res = await fetch(`https://api.github.com/repos/${currentUser}/${name}`, {
          method:'DELETE',
          headers:{ 'Authorization':`token ${currentToken}` }
        });
        if (!res.ok) throw new Error('刪除失敗');
        alert('刪除成功');
        await loadRepos();
      } catch(e) {
        alert('錯誤：'+e.message);
      }
    }

    // 啟用 Pages
    async function enablePages(repo, owner) {
      try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/pages`, {
          method:'POST',
          headers:{
            'Authorization':`token ${currentToken}`,
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ source:{ branch:'main', path:'/' }})
        });
        if (!res.ok) throw new Error('啟用 Pages 失敗');
        alert('Pages 已啟用');
        await loadRepos();
      } catch(e) {
        alert('錯誤：'+e.message);
      }
    }

    // 開新分頁
    function openSite(url) {
      window.open(url,'_blank');
    }
  </script>
</body>
</html>
